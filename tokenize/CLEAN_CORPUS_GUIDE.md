# æ–‡æœ¬è¯­æ–™æ¸…æ´—è„šæœ¬ä½¿ç”¨æŒ‡å—

## ğŸ“– ç®€ä»‹

`clean_corpus.py` æ˜¯ä¸€ä¸ªé€šç”¨çš„æ–‡æœ¬è¯­æ–™æ¸…æ´—è„šæœ¬ï¼Œç”¨äºå°†åŸå§‹æ–‡æœ¬æ–‡ä»¶æ¸…æ´—ä¸ºé€‚åˆ tokenizer è®­ç»ƒçš„æ ¼å¼ã€‚

---

## âœ¨ åŠŸèƒ½ç‰¹æ€§

### 1. æ–‡æœ¬æ¸…æ´—
- âœ… å»é™¤ç©ºè¡Œå’Œæ— æ•ˆè¡Œ
- âœ… å»é™¤å¤šä½™çš„ç©ºæ ¼å’Œç‰¹æ®Šæ§åˆ¶å­—ç¬¦
- âœ… è¿‡æ»¤è¿‡çŸ­æˆ–è¿‡é•¿çš„æ–‡æœ¬
- âœ… æ£€æµ‹å¹¶è¿‡æ»¤åƒåœ¾æ•°æ®ï¼ˆå¦‚å¤§é‡é‡å¤å­—ç¬¦ï¼‰

### 2. æ–‡æœ¬åˆå¹¶
- âœ… å°†çŸ­è¡Œåˆå¹¶ä¸ºé€‚åˆè®­ç»ƒçš„æ–‡æœ¬å—
- âœ… è‡ªåŠ¨å¤„ç†è¶…é•¿è¡Œ
- âœ… ä¿æŒæ–‡æœ¬çš„è¯­ä¹‰è¿è´¯æ€§

### 3. ç»Ÿè®¡ä¿¡æ¯
- âœ… æ˜¾ç¤ºå¤„ç†è¿›åº¦
- âœ… è¾“å‡ºè¯¦ç»†çš„ç»Ÿè®¡ä¿¡æ¯
- âœ… æ”¯æŒé¢„è§ˆè¾“å‡ºç»“æœ

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### åŸºæœ¬ç”¨æ³•

```bash
cd /Users/twrong/git/code/ChatLM-mini-Chinese/tokenize

# æ¸…æ´— wiki.txt
python clean_corpus.py \
  --input ../data/wiki.txt \
  --output ../data/my_corpus.txt

# æ¸…æ´— wiki.simple.txtï¼ˆæ¨èï¼Œæ›´å¿«ï¼‰
python clean_corpus.py \
  --input ../data/wiki.simple.txt \
  --output ../data/my_corpus.txt
```

### è‡ªå®šä¹‰å‚æ•°

```bash
python clean_corpus.py \
  --input ../data/wiki.simple.txt \
  --output ../data/my_corpus.txt \
  --target-length 2048 \
  --min-length 50 \
  --max-length 10000 \
  --preview
```

---

## ğŸ“Š å‚æ•°è¯´æ˜

### å¿…éœ€å‚æ•°

| å‚æ•° | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `--input`, `-i` | è¾“å…¥æ–‡ä»¶è·¯å¾„ | `../data/wiki.txt` |
| `--output`, `-o` | è¾“å‡ºæ–‡ä»¶è·¯å¾„ | `../data/my_corpus.txt` |

### å¯é€‰å‚æ•°

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| `--target-length` | 2048 | ç›®æ ‡æ–‡æœ¬å—é•¿åº¦ï¼ˆå­—ç¬¦æ•°ï¼‰ |
| `--min-length` | 10 | å•è¡Œæœ€å°é•¿åº¦ï¼ˆå­—ç¬¦æ•°ï¼‰ |
| `--max-length` | 50000 | å•è¡Œæœ€å¤§é•¿åº¦ï¼ˆå­—ç¬¦æ•°ï¼‰ |
| `--encoding` | utf-8 | æ–‡ä»¶ç¼–ç  |
| `--preview` | False | æ¸…æ´—å®Œæˆåé¢„è§ˆè¾“å‡ºæ–‡ä»¶ |
| `--preview-lines` | 10 | é¢„è§ˆè¡Œæ•° |

---

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹ 1ï¼šæ¸…æ´—ç»´åŸºç™¾ç§‘è¯­æ–™ï¼ˆåŸºæœ¬ï¼‰

```bash
cd /Users/twrong/git/code/ChatLM-mini-Chinese/tokenize

python clean_corpus.py \
  --input ../data/wiki.simple.txt \
  --output ../data/my_corpus.txt
```

**è¾“å‡ºç¤ºä¾‹**ï¼š
```
ğŸ“– è¯»å–è¾“å…¥æ–‡ä»¶: ../data/wiki.simple.txt
ğŸ“Š æ–‡ä»¶å¤§å°: 1100.00 MB
ğŸ”„ è¯»å–æ–‡ä»¶å†…å®¹...
ğŸ“ æ€»è¡Œæ•°: 5,234,567
ğŸ§¹ æ¸…æ´—å’Œåˆå¹¶æ–‡æœ¬...
å¤„ç†è¿›åº¦: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 5234567/5234567 [00:05<00:00]
âœ… ç”Ÿæˆæ–‡æœ¬å—æ•°: 1,234,567
ğŸ“Š ç»Ÿè®¡ä¿¡æ¯:
  - æ€»å­—ç¬¦æ•°: 2,500,000,000
  - å¹³å‡å—é•¿åº¦: 2025
  - æœ€çŸ­å—é•¿åº¦: 10
  - æœ€é•¿å—é•¿åº¦: 49999
ğŸ’¾ å†™å…¥è¾“å‡ºæ–‡ä»¶: ../data/my_corpus.txt
å†™å…¥è¿›åº¦: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 1234567/1234567 [00:02<00:00]
âœ… è¾“å‡ºæ–‡ä»¶å¤§å°: 950.00 MB
ğŸ“‰ æ•°æ®å‹ç¼©ç‡: 13.64%
ğŸ‰ æ¸…æ´—å®Œæˆï¼
```

### ç¤ºä¾‹ 2ï¼šè‡ªå®šä¹‰å‚æ•° + é¢„è§ˆ

```bash
python clean_corpus.py \
  --input ../data/wiki.simple.txt \
  --output ../data/my_corpus.txt \
  --target-length 1024 \
  --min-length 50 \
  --max-length 5000 \
  --preview \
  --preview-lines 5
```

**é¢„è§ˆè¾“å‡º**ï¼š
```
ğŸ“– é¢„è§ˆæ–‡ä»¶: ../data/my_corpus.txt
================================================================================
[1] ä¸­å›½ï¼Œæ˜¯ä½äºä¸œäºšçš„å›½å®¶ï¼Œé¦–éƒ½ä¸ºåŒ—äº¬ã€‚ä¸­å›½æ˜¯ä¸–ç•Œä¸Šäººå£æœ€å¤šçš„å›½å®¶...
--------------------------------------------------------------------------------
[2] äººå·¥æ™ºèƒ½ï¼ˆArtificial Intelligenceï¼ŒAIï¼‰æ˜¯è®¡ç®—æœºç§‘å­¦çš„ä¸€ä¸ªåˆ†æ”¯...
--------------------------------------------------------------------------------
[3] æœºå™¨å­¦ä¹ æ˜¯äººå·¥æ™ºèƒ½çš„ä¸€ä¸ªå­é¢†åŸŸï¼Œå®ƒä½¿è®¡ç®—æœºèƒ½å¤Ÿåœ¨æ²¡æœ‰æ˜ç¡®ç¼–ç¨‹çš„æƒ…å†µä¸‹å­¦ä¹ ...
--------------------------------------------------------------------------------
[4] æ·±åº¦å­¦ä¹ æ˜¯æœºå™¨å­¦ä¹ çš„ä¸€ä¸ªåˆ†æ”¯ï¼Œå®ƒåŸºäºäººå·¥ç¥ç»ç½‘ç»œ...
--------------------------------------------------------------------------------
[5] è‡ªç„¶è¯­è¨€å¤„ç†ï¼ˆNatural Language Processingï¼ŒNLPï¼‰æ˜¯äººå·¥æ™ºèƒ½å’Œè¯­è¨€å­¦çš„äº¤å‰é¢†åŸŸ...
--------------------------------------------------------------------------------
================================================================================
```

### ç¤ºä¾‹ 3ï¼šå¤„ç†ä¸åŒçš„æ–‡æœ¬æ–‡ä»¶

```bash
# å¤„ç†è‡ªå®šä¹‰æ–‡æœ¬æ–‡ä»¶
python clean_corpus.py \
  --input /path/to/your/text.txt \
  --output ../data/my_corpus.txt

# å¤„ç†å¤šä¸ªæ–‡ä»¶ï¼ˆéœ€è¦å…ˆåˆå¹¶ï¼‰
cat file1.txt file2.txt file3.txt > combined.txt
python clean_corpus.py \
  --input combined.txt \
  --output ../data/my_corpus.txt
```

---

## ğŸ” æ¸…æ´—è§„åˆ™è¯¦è§£

### 1. æ–‡æœ¬æ¸…æ´—è§„åˆ™

#### âœ… ä¿ç•™çš„å†…å®¹
- ä¸­æ–‡å­—ç¬¦ï¼ˆ\u4e00-\u9fa5ï¼‰
- è‹±æ–‡å­—æ¯ï¼ˆa-zA-Zï¼‰
- æ•°å­—ï¼ˆ0-9ï¼‰
- å¸¸è§æ ‡ç‚¹ç¬¦å·
- å•ä¸ªç©ºæ ¼

#### âŒ è¿‡æ»¤çš„å†…å®¹
- ç©ºè¡Œ
- çº¯ç©ºæ ¼è¡Œ
- ç‰¹æ®Šæ§åˆ¶å­—ç¬¦ï¼ˆ\x00-\x1fï¼‰
- è¿‡çŸ­çš„è¡Œï¼ˆ< min-lengthï¼‰
- è¿‡é•¿çš„è¡Œï¼ˆ> max-lengthï¼‰
- å¤§é‡é‡å¤å­—ç¬¦ï¼ˆå¦‚ï¼šaaaaaaaaaa...ï¼‰
- ä¸åŒ…å«ä¸­è‹±æ–‡æˆ–æ•°å­—çš„è¡Œ

### 2. æ–‡æœ¬åˆå¹¶è§„åˆ™

#### åˆå¹¶ç­–ç•¥
1. ç´¯ç§¯çŸ­è¡Œç›´åˆ°è¾¾åˆ° `target-length`
2. ä½¿ç”¨ç©ºæ ¼è¿æ¥å¤šè¡Œæ–‡æœ¬
3. è¶…é•¿è¡Œç›´æ¥è¾“å‡ºï¼Œä¸åˆå¹¶
4. ä¿æŒæ–‡æœ¬çš„è¯­ä¹‰è¿è´¯æ€§

#### ç¤ºä¾‹

**è¾“å…¥**ï¼š
```
è¿™æ˜¯ç¬¬ä¸€è¡Œã€‚
è¿™æ˜¯ç¬¬äºŒè¡Œã€‚
è¿™æ˜¯ç¬¬ä¸‰è¡Œã€‚
```

**è¾“å‡º**ï¼ˆtarget-length=50ï¼‰ï¼š
```
è¿™æ˜¯ç¬¬ä¸€è¡Œã€‚ è¿™æ˜¯ç¬¬äºŒè¡Œã€‚ è¿™æ˜¯ç¬¬ä¸‰è¡Œã€‚
```

---

## ğŸ“Š è¾“å‡ºæ ¼å¼

### æ–‡ä»¶æ ¼å¼
- æ¯è¡Œä¸€ä¸ªæ–‡æœ¬å—
- ä½¿ç”¨ UTF-8 ç¼–ç 
- ä»¥æ¢è¡Œç¬¦åˆ†éš”

### æ–‡æœ¬å—ç‰¹ç‚¹
- é•¿åº¦æ¥è¿‘ `target-length`
- ä¸åŒ…å«å¤šä½™çš„ç©ºæ ¼å’Œç‰¹æ®Šå­—ç¬¦
- é€‚åˆ tokenizer è®­ç»ƒ

---

## ğŸ¯ æ¨èé…ç½®

### é…ç½® 1ï¼šæ ‡å‡†é…ç½®ï¼ˆæ¨èï¼‰

é€‚ç”¨äºå¤§å¤šæ•°åœºæ™¯ï¼š

```bash
python clean_corpus.py \
  --input ../data/wiki.simple.txt \
  --output ../data/my_corpus.txt \
  --target-length 2048 \
  --min-length 10 \
  --max-length 50000
```

### é…ç½® 2ï¼šå¿«é€Ÿé…ç½®

é€‚ç”¨äºå¿«é€Ÿæµ‹è¯•ï¼š

```bash
python clean_corpus.py \
  --input ../data/wiki.simple.txt \
  --output ../data/my_corpus.txt \
  --target-length 1024 \
  --min-length 50 \
  --max-length 5000
```

### é…ç½® 3ï¼šé«˜è´¨é‡é…ç½®

é€‚ç”¨äºé«˜è´¨é‡è®­ç»ƒï¼š

```bash
python clean_corpus.py \
  --input ../data/wiki.txt \
  --output ../data/my_corpus.txt \
  --target-length 4096 \
  --min-length 100 \
  --max-length 10000
```

---

## ğŸ”§ æ•…éšœæ’é™¤

### é—®é¢˜ 1ï¼šå†…å­˜ä¸è¶³

**ç—‡çŠ¶**ï¼š
```
MemoryError: Unable to allocate array
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ä½¿ç”¨æ›´å°çš„è¾“å…¥æ–‡ä»¶ï¼ˆå¦‚ `wiki.simple.txt`ï¼‰
2. åˆ†æ‰¹å¤„ç†å¤§æ–‡ä»¶
3. å¢åŠ ç³»ç»Ÿå†…å­˜

### é—®é¢˜ 2ï¼šæ–‡ä»¶ç¼–ç é”™è¯¯

**ç—‡çŠ¶**ï¼š
```
UnicodeDecodeError: 'utf-8' codec can't decode byte
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# å°è¯•å…¶ä»–ç¼–ç 
python clean_corpus.py \
  --input ../data/wiki.txt \
  --output ../data/my_corpus.txt \
  --encoding gbk
```

### é—®é¢˜ 3ï¼šè¾“å‡ºæ–‡ä»¶å¤ªå°

**ç—‡çŠ¶**ï¼š
è¾“å‡ºæ–‡ä»¶è¿œå°äºé¢„æœŸ

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. å‡å° `--min-length` å‚æ•°
2. å¢å¤§ `--max-length` å‚æ•°
3. æ£€æŸ¥è¾“å…¥æ–‡ä»¶è´¨é‡

### é—®é¢˜ 4ï¼šå¤„ç†é€Ÿåº¦å¤ªæ…¢

**ç—‡çŠ¶**ï¼š
å¤„ç†å¤§æ–‡ä»¶æ—¶é€Ÿåº¦å¾ˆæ…¢

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ä½¿ç”¨ `wiki.simple.txt` è€Œä¸æ˜¯ `wiki.txt`
2. å¢å¤§ `--target-length` å‚æ•°ï¼ˆå‡å°‘æ–‡æœ¬å—æ•°é‡ï¼‰
3. ä½¿ç”¨ SSD ç¡¬ç›˜

---

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡

### å¤„ç†é€Ÿåº¦

| æ–‡ä»¶å¤§å° | å¤„ç†æ—¶é—´ | é€Ÿåº¦ |
|---------|---------|------|
| 100 MB | ~10 ç§’ | ~10 MB/s |
| 500 MB | ~50 ç§’ | ~10 MB/s |
| 1 GB | ~2 åˆ†é’Ÿ | ~8 MB/s |
| 5 GB | ~10 åˆ†é’Ÿ | ~8 MB/s |

*æ³¨ï¼šå®é™…é€Ÿåº¦å–å†³äºç¡¬ä»¶é…ç½®å’Œæ–‡ä»¶å†…å®¹*

### æ•°æ®å‹ç¼©ç‡

| è¾“å…¥æ–‡ä»¶ | è¾“å‡ºæ–‡ä»¶ | å‹ç¼©ç‡ |
|---------|---------|--------|
| wiki.txt (1.1 GB) | my_corpus.txt (~950 MB) | ~13% |
| wiki.simple.txt (1.1 GB) | my_corpus.txt (~950 MB) | ~13% |

---

## ğŸ”„ å®Œæ•´å·¥ä½œæµç¨‹

### æ­¥éª¤ 1ï¼šæ¸…æ´—è¯­æ–™

```bash
cd /Users/twrong/git/code/ChatLM-mini-Chinese/tokenize

python clean_corpus.py \
  --input ../data/wiki.simple.txt \
  --output ../data/my_corpus.txt \
  --preview
```

### æ­¥éª¤ 2ï¼šè®­ç»ƒ Tokenizer

```bash
python train_tokenizer.py \
  --method t5-base \
  --wiki-file ../data/my_corpus.txt \
  --output-dir ../model_save/my_tokenizer_wiki \
  --vocab-size 40960 \
  --batch-size 500
```

### æ­¥éª¤ 3ï¼šéªŒè¯ç»“æœ

```bash
# æ£€æŸ¥è¾“å‡ºæ–‡ä»¶
ls -lh ../data/my_corpus.txt

# é¢„è§ˆå†…å®¹
head -20 ../data/my_corpus.txt

# ç»Ÿè®¡è¡Œæ•°
wc -l ../data/my_corpus.txt
```

---

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. é€‰æ‹©åˆé€‚çš„è¾“å…¥æ–‡ä»¶

| æ–‡ä»¶ | ä¼˜ç‚¹ | ç¼ºç‚¹ | æ¨èåœºæ™¯ |
|------|------|------|---------|
| `wiki.txt` | æ•°æ®å®Œæ•´ | æ–‡ä»¶å¤§ï¼Œå¤„ç†æ…¢ | é«˜è´¨é‡è®­ç»ƒ |
| `wiki.simple.txt` | å¤„ç†å¿« | æ•°æ®è¾ƒå°‘ | å¿«é€Ÿæµ‹è¯• |

### 2. è°ƒæ•´å‚æ•°

- **target-length**ï¼š
  - å°å€¼ï¼ˆ1024ï¼‰ï¼šæ›´å¤šæ–‡æœ¬å—ï¼Œè®­ç»ƒæ›´ç»†è‡´
  - å¤§å€¼ï¼ˆ4096ï¼‰ï¼šæ›´å°‘æ–‡æœ¬å—ï¼Œè®­ç»ƒæ›´å¿«

- **min-length**ï¼š
  - å°å€¼ï¼ˆ10ï¼‰ï¼šä¿ç•™æ›´å¤šæ•°æ®
  - å¤§å€¼ï¼ˆ100ï¼‰ï¼šè¿‡æ»¤ä½è´¨é‡æ•°æ®

- **max-length**ï¼š
  - å°å€¼ï¼ˆ5000ï¼‰ï¼šé¿å…è¶…é•¿æ–‡æœ¬
  - å¤§å€¼ï¼ˆ50000ï¼‰ï¼šä¿ç•™å®Œæ•´æ–‡ç« 

### 3. éªŒè¯è¾“å‡ºè´¨é‡

```bash
# é¢„è§ˆè¾“å‡ºæ–‡ä»¶
python clean_corpus.py \
  --input ../data/wiki.simple.txt \
  --output ../data/my_corpus.txt \
  --preview \
  --preview-lines 20

# ç»Ÿè®¡ä¿¡æ¯
wc -l ../data/my_corpus.txt  # è¡Œæ•°
wc -c ../data/my_corpus.txt  # å­—èŠ‚æ•°
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [train_tokenizer.py ä½¿ç”¨æŒ‡å—](./train_tokenizer.py)
- [Tokenizer è®­ç»ƒé”™è¯¯ä¿®å¤è¯´æ˜](./BUGFIX_TOKENIZER_TRAINING.md)

---

## ğŸ‰ æ€»ç»“

### æ ¸å¿ƒåŠŸèƒ½
- âœ… æ¸…æ´—æ–‡æœ¬æ–‡ä»¶
- âœ… åˆå¹¶çŸ­è¡Œ
- âœ… è¿‡æ»¤æ— æ•ˆæ•°æ®
- âœ… ç”Ÿæˆé€‚åˆè®­ç»ƒçš„æ ¼å¼

### æ¨èå‘½ä»¤

```bash
# æœ€æ¨èçš„å‘½ä»¤
cd /Users/twrong/git/code/ChatLM-mini-Chinese/tokenize

python clean_corpus.py \
  --input ../data/wiki.simple.txt \
  --output ../data/my_corpus.txt \
  --target-length 2048 \
  --min-length 10 \
  --max-length 50000 \
  --preview
```

### ä¸‹ä¸€æ­¥

æ¸…æ´—å®Œæˆåï¼Œä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è®­ç»ƒ tokenizerï¼š

```bash
python train_tokenizer.py \
  --method t5-base \
  --wiki-file ../data/my_corpus.txt \
  --output-dir ../model_save/my_tokenizer_wiki \
  --vocab-size 40960 \
  --batch-size 500
```

---

**ç°åœ¨å¯ä»¥å¼€å§‹æ¸…æ´—æ•°æ®äº†ï¼** ğŸš€
