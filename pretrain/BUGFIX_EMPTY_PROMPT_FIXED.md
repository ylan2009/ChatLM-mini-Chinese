# Bug ä¿®å¤ï¼šprompt å…¨éƒ¨ä¸ºç©ºçš„é—®é¢˜

## ðŸ› é—®é¢˜æè¿°

æ ¹æ®è¯Šæ–­æŠ¥å‘Šï¼Œ`process_belle_knowledge_enhanced_dataset_for_finetune` å‡½æ•°ç”Ÿæˆçš„æ•°æ®ä¸­ï¼Œ**æ‰€æœ‰çš„ prompt éƒ½æ˜¯ç©ºçš„**ï¼š

```
å¤„ç†åŽçš„å¾®è°ƒæ•°æ®: 1,761,347 è¡Œ
- æœ‰æ•ˆæ•°æ®: 0 (0.0%)
- ç©º Prompt: 1,761,347 (100.0%)  âŒ æ‰€æœ‰ prompt éƒ½æ˜¯ç©ºçš„ï¼
- ç©º Response: 38 (0.0%)
```

---

## ðŸ” é—®é¢˜æ ¹æº

### è¯Šæ–­ç»“æžœ

è¿è¡Œ `diagnose_belle_files.py` åŽå‘çŽ°ï¼š

```
åˆ—ååŒ¹é…æ£€æŸ¥:
âœ… æ‰¾åˆ° prompt åˆ—: instruction
âœ… æ‰¾åˆ° prompt åˆ—: input
âœ… æ‰¾åˆ° response åˆ—: output

æ•°æ®æ ·ä¾‹:
instruction: æ ¹æ®æ–‡æœ¬ç”Ÿæˆä¸€æ®µç®€çŸ­çš„æ‘˜è¦ã€‚
input:                    âŒ ç©ºçš„ï¼
output: ä¹”æ²»Â·åŽç››é¡¿å‡ºç”Ÿåœ¨1732å¹´2æœˆ22æ—¥...
```

**å…³é”®å‘çŽ°**ï¼š
- Belle æ•°æ®æ–‡ä»¶ä¸­æœ‰ `instruction` å’Œ `input` ä¸¤åˆ—
- `instruction` åˆ—æœ‰æ•°æ® âœ…
- `input` åˆ—æ˜¯ç©ºçš„ âŒ

### ä»£ç é—®é¢˜

åŽŸå§‹çš„åˆ—åè¯†åˆ«é€»è¾‘ï¼š

```python
# âŒ é”™è¯¯çš„ä»£ç 
for col in columns:
    col_lower = col.lower()
    if col_lower in ['instruction', 'prompt', 'input', 'question']:
        prompt_col = col  # ä¼šè¢«åŽé¢çš„åˆ—è¦†ç›–ï¼
    elif col_lower in ['output', 'response', 'answer', 'target']:
        response_col = col
```

**é—®é¢˜æµç¨‹**ï¼š
1. å¾ªçŽ¯éåŽ†åˆ—åï¼š`['instruction', 'input', 'output']`
2. æ‰¾åˆ° `instruction` â†’ è®¾ç½® `prompt_col = 'instruction'` âœ…
3. æ‰¾åˆ° `input` â†’ **è¦†ç›–**ä¸º `prompt_col = 'input'` âŒ
4. æœ€ç»ˆä½¿ç”¨çš„æ˜¯ç©ºçš„ `input` åˆ—ï¼Œè€Œä¸æ˜¯æœ‰æ•°æ®çš„ `instruction` åˆ—
5. å¯¼è‡´æ‰€æœ‰ prompt éƒ½æ˜¯ç©ºçš„

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤æ€è·¯

ä½¿ç”¨**ä¼˜å…ˆçº§é¡ºåº**æ¥é€‰æ‹©åˆ—åï¼Œè€Œä¸æ˜¯ç®€å•çš„å¾ªçŽ¯è¦†ç›–ï¼š

1. å®šä¹‰åˆ—åä¼˜å…ˆçº§åˆ—è¡¨ï¼ˆä»Žé«˜åˆ°ä½Žï¼‰
2. æŒ‰ä¼˜å…ˆçº§é¡ºåºæŸ¥æ‰¾åˆ—å
3. æ‰¾åˆ°ç¬¬ä¸€ä¸ªåŒ¹é…çš„åˆ—ååŽç«‹å³åœæ­¢

### ä¿®å¤ä»£ç 

```python
# âœ… æ­£ç¡®çš„ä»£ç 
# è¯†åˆ«æ™®é€šæ ¼å¼çš„åˆ—åï¼ˆä¼˜å…ˆçº§é¡ºåºå¾ˆé‡è¦ï¼ï¼‰
prompt_col = None
response_col = None

# å®šä¹‰åˆ—åä¼˜å…ˆçº§ï¼ˆä»Žé«˜åˆ°ä½Žï¼‰
prompt_priority = ['instruction', 'prompt', 'question', 'input']  # instruction ä¼˜å…ˆçº§æœ€é«˜
response_priority = ['output', 'response', 'answer', 'target']

# æŒ‰ä¼˜å…ˆçº§æŸ¥æ‰¾ prompt åˆ—
for candidate in prompt_priority:
    for col in columns:
        if col.lower() == candidate:
            prompt_col = col
            break
    if prompt_col:
        break  # æ‰¾åˆ°åŽç«‹å³åœæ­¢

# æŒ‰ä¼˜å…ˆçº§æŸ¥æ‰¾ response åˆ—
for candidate in response_priority:
    for col in columns:
        if col.lower() == candidate:
            response_col = col
            break
    if response_col:
        break  # æ‰¾åˆ°åŽç«‹å³åœæ­¢
```

### ä¼˜å…ˆçº§è¯´æ˜Ž

#### Prompt åˆ—ä¼˜å…ˆçº§ï¼ˆä»Žé«˜åˆ°ä½Žï¼‰

1. **`instruction`** - æœ€å¸¸ç”¨ï¼Œé€šå¸¸åŒ…å«å®Œæ•´çš„æŒ‡ä»¤
2. **`prompt`** - é€šç”¨çš„ prompt åˆ—å
3. **`question`** - é—®ç­”æ ¼å¼çš„æ•°æ®
4. **`input`** - ä¼˜å…ˆçº§æœ€ä½Žï¼Œå› ä¸ºå¯èƒ½æ˜¯ç©ºçš„

#### Response åˆ—ä¼˜å…ˆçº§ï¼ˆä»Žé«˜åˆ°ä½Žï¼‰

1. **`output`** - æœ€å¸¸ç”¨çš„è¾“å‡ºåˆ—å
2. **`response`** - é€šç”¨çš„å“åº”åˆ—å
3. **`answer`** - é—®ç­”æ ¼å¼çš„ç­”æ¡ˆ
4. **`target`** - ç›®æ ‡è¾“å‡º

---

## ðŸ“Š ä¿®å¤æ•ˆæžœ

### ä¿®å¤å‰ï¼ˆé”™è¯¯ï¼‰

```
åˆ—å: ['instruction', 'input', 'output']
é€‰æ‹©çš„åˆ—: prompt_col = 'input'  âŒ ç©ºåˆ—
ç»“æžœ: æ‰€æœ‰ prompt éƒ½æ˜¯ç©ºçš„
```

### ä¿®å¤åŽï¼ˆæ­£ç¡®ï¼‰

```
åˆ—å: ['instruction', 'input', 'output']
é€‰æ‹©çš„åˆ—: prompt_col = 'instruction'  âœ… æœ‰æ•°æ®çš„åˆ—
ç»“æžœ: prompt æ­£å¸¸
```

---

## ðŸ”§ éªŒè¯ä¿®å¤

### æ­¥éª¤ 1ï¼šåˆ é™¤æ—§çš„è¾“å‡ºæ–‡ä»¶

```bash
rm /data3/ChatLM-mini-Chinese/data/my_finetune_data_zh.parquet
```

### æ­¥éª¤ 2ï¼šé‡æ–°è¿è¡Œå¤„ç†

```bash
cd /Users/twrong/git/code/ChatLM-mini-Chinese/pretrain
python download_and_process_datasets.py --process
```

æˆ–è€…åªè¿è¡Œå¾®è°ƒæ•°æ®å¤„ç†ï¼š

```python
from raw_data_process import process_belle_knowledge_enhanced_dataset_for_finetune
from config import PROJECT_ROOT

process_belle_knowledge_enhanced_dataset_for_finetune(
    max_len=320,
    group_cnt=50000
)
```

### æ­¥éª¤ 3ï¼šéªŒè¯ç»“æžœ

ä½¿ç”¨è¯Šæ–­å·¥å…·éªŒè¯ï¼š

```bash
python check_data_pipeline.py --file /data3/ChatLM-mini-Chinese/data/my_finetune_data_zh.parquet
```

**é¢„æœŸç»“æžœ**ï¼š

```
å¤„ç†åŽçš„å¾®è°ƒæ•°æ®: 1,761,347 è¡Œ
- æœ‰æ•ˆæ•°æ®: >90%  âœ…
- ç©º Prompt: <10%  âœ…
- ç©º Response: <1%  âœ…
```

---

## ðŸ“ ä¿®æ”¹çš„æ–‡ä»¶

### [raw_data_process.py](/Users/twrong/git/code/ChatLM-mini-Chinese/pretrain/raw_data_process.py)

**ä¿®æ”¹ä½ç½®**ï¼šç¬¬ 1878-1897 è¡Œ

**ä¿®æ”¹å†…å®¹**ï¼š
- å°†ç®€å•çš„å¾ªçŽ¯è¦†ç›–æ”¹ä¸ºä¼˜å…ˆçº§é¡ºåºæŸ¥æ‰¾
- ç¡®ä¿ä¼˜å…ˆä½¿ç”¨ `instruction` è€Œä¸æ˜¯ `input`
- æ‰¾åˆ°ç¬¬ä¸€ä¸ªåŒ¹é…çš„åˆ—ååŽç«‹å³åœæ­¢

---

## ðŸ’¡ ç»éªŒæ•™è®­

### 1. åˆ—åè¯†åˆ«è¦è€ƒè™‘ä¼˜å…ˆçº§

ä¸åŒçš„åˆ—åå¯èƒ½åŒæ—¶å­˜åœ¨ï¼Œéœ€è¦å®šä¹‰ä¼˜å…ˆçº§ï¼š
- âœ… ä½¿ç”¨ä¼˜å…ˆçº§åˆ—è¡¨
- âŒ ç®€å•çš„å¾ªçŽ¯è¦†ç›–

### 2. è¦æ£€æŸ¥åˆ—æ˜¯å¦ä¸ºç©º

å³ä½¿åˆ—ååŒ¹é…ï¼Œä¹Ÿè¦æ£€æŸ¥åˆ—æ˜¯å¦æœ‰æ•°æ®ï¼š
- å¯ä»¥åœ¨é€‰æ‹©åˆ—åŽæ£€æŸ¥å‰å‡ è¡Œæ˜¯å¦ä¸ºç©º
- å¦‚æžœä¸ºç©ºï¼Œå°è¯•ä¸‹ä¸€ä¸ªå€™é€‰åˆ—

### 3. è¯Šæ–­å·¥å…·å¾ˆé‡è¦

é€šè¿‡ `diagnose_belle_files.py` å¿«é€Ÿå®šä½äº†é—®é¢˜ï¼š
- æ˜¾ç¤ºäº†åˆ—å
- æ˜¾ç¤ºäº†æ•°æ®æ ·ä¾‹
- å‘çŽ°äº† `input` åˆ—æ˜¯ç©ºçš„

### 4. æ—¥å¿—è¦è¯¦ç»†

æ·»åŠ æ—¥å¿—æ˜¾ç¤ºé€‰æ‹©çš„åˆ—åï¼š
```python
log.info(f'ä½¿ç”¨åˆ—: prompt={prompt_col}, response={response_col}', save_to_file=True)
```

è¿™æ ·å¯ä»¥å¿«é€Ÿå‘çŽ°é—®é¢˜ã€‚

---

## ðŸŽ¯ æ€»ç»“

### é—®é¢˜æœ¬è´¨
- Belle æ•°æ®æ–‡ä»¶ä¸­æœ‰å¤šä¸ªå€™é€‰åˆ—ï¼ˆ`instruction` å’Œ `input`ï¼‰
- åŽŸå§‹ä»£ç ä½¿ç”¨ç®€å•çš„å¾ªçŽ¯è¦†ç›–ï¼Œå¯¼è‡´é€‰æ‹©äº†ç©ºçš„ `input` åˆ—
- åº”è¯¥ä½¿ç”¨ä¼˜å…ˆçº§é¡ºåºï¼Œä¼˜å…ˆé€‰æ‹©æœ‰æ•°æ®çš„ `instruction` åˆ—

### ä¿®å¤æ–¹æ³•
- å®šä¹‰åˆ—åä¼˜å…ˆçº§åˆ—è¡¨
- æŒ‰ä¼˜å…ˆçº§é¡ºåºæŸ¥æ‰¾
- æ‰¾åˆ°ç¬¬ä¸€ä¸ªåŒ¹é…çš„åˆ—ååŽç«‹å³åœæ­¢

### ä¿®å¤æ•ˆæžœ
- âœ… æ­£ç¡®é€‰æ‹© `instruction` åˆ—
- âœ… prompt ä¸å†ä¸ºç©º
- âœ… æ•°æ®è´¨é‡æ¢å¤æ­£å¸¸

---

**ä¿®å¤æ—¥æœŸ**: 2026-02-05  
**Bug ä¸¥é‡ç¨‹åº¦**: ðŸ”´ é«˜ï¼ˆå¯¼è‡´æ‰€æœ‰æ•°æ®æ— æ•ˆï¼‰  
**ä¿®å¤çŠ¶æ€**: âœ… å·²ä¿®å¤  
**æµ‹è¯•çŠ¶æ€**: â³ å¾…éªŒè¯

---

## ðŸš€ ä¸‹ä¸€æ­¥

1. âœ… åˆ é™¤æ—§çš„è¾“å‡ºæ–‡ä»¶
2. âœ… é‡æ–°è¿è¡Œæ•°æ®å¤„ç†
3. âœ… ä½¿ç”¨è¯Šæ–­å·¥å…·éªŒè¯ç»“æžœ
4. âœ… æ£€æŸ¥æ—¥å¿—ç¡®è®¤ä½¿ç”¨äº†æ­£ç¡®çš„åˆ—å

**è¯·é‡æ–°è¿è¡Œæ•°æ®å¤„ç†ï¼Œç„¶åŽå‘Šè¯‰æˆ‘ç»“æžœï¼** ðŸŽ‰
