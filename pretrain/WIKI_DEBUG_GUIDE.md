# Wiki 数据处理调试指南

## 📋 添加的调试信息

为了诊断 wiki 数据处理只剩 1 行的问题，我在 `process_wiki_simple_to_dataset()` 函数中添加了详细的调试日志。

## 🔍 调试日志说明

### 1. 启动信息

```
开始处理wiki数据，skip_clean=True
判断冒号类型: 英文冒号(:)
```

- 显示 `skip_clean` 参数的值
- 显示使用的冒号类型（英文或中文）

### 2. 进度信息（每 10 万行）

```
已处理 100000 行，识别标题 X 个，内容行 Y 行，保存 Z 条
已处理 200000 行，识别标题 X 个，内容行 Y 行，保存 Z 条
...
```

- **总行数**：已处理的总行数
- **识别标题数**：识别到的词条标题数量
- **内容行数**：处理的内容行数量
- **保存条数**：保存的问答对数量

### 3. 标题识别信息（前 10 个）

```
识别标题 #1: '数学' -> prompt: '什么是数学？'
识别标题 #2: '词源' -> prompt: '介绍一下词源'
...
```

- 显示识别到的词条标题
- 显示生成的问题（prompt）

### 4. 内容行判断信息（前 20 行）

```
内容行 #0: line末尾='...', endswith(':')=False, len(line)=123, pre_line_len=0
内容行 #1: line末尾='...', endswith(':')=False, len(line)=456, pre_line_len=123
...
```

- **line末尾**：显示行的末尾字符（最后 10 个字符）
- **endswith(':')**: 是否以冒号结尾（用于判断是否是标题行）
- **len(line)**：清洗后的行长度
- **pre_line_len**：上一行的长度（用于判断是否是空行）

### 5. 保存样例信息（前 5 个）

```
保存样例 #1: prompt='什么是数学？', response='数学是利用符号语言研究数量、结构、变化以及空间等概念的一门学科...'
保存样例 #2: prompt='介绍一下词源', response='西方语言中"数学"（）一词源自于古希腊语的（）...'
...
```

- 显示保存的问答对内容（前 50 个字符）

### 6. 最终统计信息

```
============================================================
处理完成统计:
  - 总行数: 6791470
  - 识别标题数: 1234567
  - 处理内容行数: 5000000
  - 保存问答对数: 1190000
  - keep_cnt: 1190000
============================================================
merge into file: .../wiki_zh_simple.parquet, 全部数据共6791470行，清洗后剩余1190000行
```

- **总行数**：wiki.simple.txt 的总行数
- **识别标题数**：识别到的词条标题数量
- **处理内容行数**：处理的内容行数量
- **保存问答对数**：保存的问答对数量
- **keep_cnt**：最终保存的数据条数

## 🎯 如何使用调试信息

### 运行脚本

```bash
cd pretrain
python download_and_process_datasets.py --process
```

或者直接运行：

```bash
cd pretrain
python -c "from raw_data_process import process_wiki_simple_to_dataset; process_wiki_simple_to_dataset()"
```

### 查看日志

日志会输出到：
- **控制台**：实时显示
- **日志文件**：`logs/download_datasets.log`

### 分析问题

根据调试信息，可以判断问题出在哪里：

#### 情况 1：识别标题数为 0

```
识别标题数: 0
```

**问题**：没有识别到任何标题行

**可能原因**：
- wiki.simple.txt 格式不正确
- 标题行不是以英文冒号 `:` 结尾
- 标题行前面不是空行（`pre_line_len != 0`）

**解决方案**：
- 检查 wiki.simple.txt 的格式
- 查看前 10 行的内容：`head -20 data/wiki.simple.txt`

#### 情况 2：识别标题数正常，但内容行数为 0

```
识别标题数: 100000
处理内容行数: 0
```

**问题**：识别到标题，但没有处理内容行

**可能原因**：
- 内容行被误判为标题行（以冒号结尾）
- `skip_clean` 参数设置错误，导致冒号类型不匹配

**解决方案**：
- 查看"内容行判断信息"，看 `endswith(':')` 的值
- 检查内容行是否包含英文冒号

#### 情况 3：处理内容行数正常，但保存条数为 0

```
识别标题数: 100000
处理内容行数: 5000000
保存问答对数: 0
```

**问题**：处理了内容，但没有保存

**可能原因**：
- 内容长度不满足条件
- `pre_line_len` 判断逻辑错误

**解决方案**：
- 检查 `max_len` 参数
- 查看"保存样例信息"，看是否有保存

#### 情况 4：只保存了 1 条（当前问题）

```
保存问答对数: 1
```

**问题**：只保存了 1 条数据

**可能原因**：
- 大部分内容行被误判为标题行
- 冒号类型不匹配

**解决方案**：
- 查看"内容行判断信息"，重点关注 `endswith(':')` 的值
- 如果大部分内容行的 `endswith(':')=True`，说明冒号类型不匹配
- 检查 `skip_clean` 参数是否正确

## 📊 预期的正常输出

正常情况下，应该看到类似这样的输出：

```
开始处理wiki数据，skip_clean=True
判断冒号类型: 英文冒号(:)

识别标题 #1: '数学' -> prompt: '什么是数学？'
识别标题 #2: '词源' -> prompt: '介绍一下词源'
识别标题 #3: '历史' -> prompt: '你知道历史吗？'
...

内容行 #0: line末尾='...的一门学科', endswith(':')=False, len(line)=123, pre_line_len=0
内容行 #1: line末尾='...不可或缺', endswith(':')=False, len(line)=456, pre_line_len=123
...

已处理 100000 行，识别标题 5000 个，内容行 80000 行，保存 4500 条
已处理 200000 行，识别标题 10000 个，内容行 160000 行，保存 9000 条
...

保存样例 #1: prompt='什么是数学？', response='数学是利用符号语言研究数量、结构、变化以及空间等概念的一门学科...'
保存样例 #2: prompt='介绍一下词源', response='西方语言中"数学"（）一词源自于古希腊语的（）...'
...

============================================================
处理完成统计:
  - 总行数: 6791470
  - 识别标题数: 1234567
  - 处理内容行数: 5000000
  - 保存问答对数: 1190000
  - keep_cnt: 1190000
============================================================
merge into file: .../wiki_zh_simple.parquet, 全部数据共6791470行，清洗后剩余1190000行
```

## 🔧 关键指标

| 指标 | 预期值 | 说明 |
|------|--------|------|
| **识别标题数** | ~120 万 | 应该识别到大量的词条标题 |
| **处理内容行数** | ~500 万 | 应该处理大量的内容行 |
| **保存问答对数** | ~119 万 | 应该保存大量的问答对 |
| **识别率** | ~18% | 识别标题数 / 总行数 |
| **保存率** | ~98% | 保存数 / 识别标题数 |

如果这些指标严重偏离预期值，说明存在问题。

## 💡 调试技巧

### 1. 查看前几行的处理逻辑

重点关注前 10 个标题和前 20 行内容的判断信息，这能帮助你快速定位问题。

### 2. 检查冒号类型

如果看到大量的 `endswith(':')=True`，说明内容行被误判为标题行，需要检查冒号类型是否匹配。

### 3. 检查 wiki.simple.txt 格式

```bash
# 查看前 50 行
head -50 data/wiki.simple.txt

# 查看是否有英文冒号
grep -n ":" data/wiki.simple.txt | head -20

# 查看是否有中文冒号
grep -n "：" data/wiki.simple.txt | head -20
```

### 4. 手动测试

可以创建一个小的测试文件，验证处理逻辑：

```python
# test_wiki.py
from raw_data_process import process_wiki_simple_to_dataset

# 使用调试模式处理
process_wiki_simple_to_dataset(skip_clean=True)
```

---

**最后更新**：2026-02-02
