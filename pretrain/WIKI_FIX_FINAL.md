# Wiki 数据处理问题修复 - 最终版本

## 🐛 问题描述

wiki 数据处理后只剩 1 行，日志显示：
```
- 总行数: 6,791,470
- 识别标题数: 1 个（应该是 ~120 万个）
- 处理内容行数: 5 行
- 保存问答对数: 1 条
```

## 🔍 问题根源

### wiki.simple.txt 的实际格式

```
数学:
数学是利用符号语言研究数量、结构、变化以及空间等概念的一门学科...
基础数学的知识与运用总是个人与团体生活中不可或缺的一环...
今日，数学使用在不同的领域中...
词源.
西方语言中"数学"（）一词源自于古希腊语的（）...
汉字表示的「数学」一词大约产生于中国宋元时期...
历史.
数学有着久远的历史...
```

**格式特点**：
1. **主标题**：以英文冒号 `:` 结尾（如 `数学:`）
2. **子标题**：以句号 `.` 结尾（如 `词源.`、`历史.`）
3. **标题后直接是内容**，没有空行

### 原代码的问题

```python
# 错误的逻辑
if prompt == '' and line_stripped.endswith(':') and pre_line_len == 0:
    # 只识别以冒号结尾且上一行是空行的标题
    title = line_stripped[0: -1]
    prompt = choice(prompt_prefix).format(title)
    continue
```

**为什么只识别到 1 个标题**：
1. 第一个标题 `数学:` 满足条件：
   - 以冒号 `:` 结尾 ✓
   - 上一行是空行（文件开头，`pre_line_len == 0`）✓
   - 被正确识别

2. 子标题 `词源.`、`历史.` 不满足条件：
   - 以句号 `.` 结尾，不是冒号 ✗
   - 上一行不是空行（是内容行）✗
   - **没有被识别**

3. 后续的主标题（如果有）也不满足条件：
   - 虽然以冒号 `:` 结尾 ✓
   - 但上一行不是空行（`pre_line_len != 0`）✗
   - **没有被识别**

## ✅ 解决方案

### 修改后的逻辑

```python
# 正确的逻辑
is_title = False
title = ''

# 1. 主标题：以英文冒号结尾，且上一行是空行
if prompt == '' and line_stripped.endswith(':') and pre_line_len == 0:
    title = line_stripped[0: -1]  # 去掉末尾的冒号
    is_title = True

# 2. 子标题：以句号结尾，且长度较短（<= 20个字符）
elif line_stripped.endswith('.') and len(line_stripped) <= 20 and len(line_stripped) > 0:
    title = line_stripped[0: -1]  # 去掉末尾的句号
    is_title = True

if is_title:
    # 如果之前有未保存的内容，先保存
    if prompt != '' and response != '':
        keep_cnt += 1
        saved_cnt += 1
        append({'prompt': prompt, 'response': ''.join(response[0: max_len])})
    
    # 设置新的标题
    prompt = choice(prompt_prefix).format(title)
    response = ''
    pre_line_len = len(line_stripped)
    title_cnt += 1
    
    continue
```

### 关键改进

1. **识别两种标题格式**：
   - 主标题：以 `:` 结尾（如 `数学:`）
   - 子标题：以 `.` 结尾且长度 ≤ 20（如 `词源.`、`历史.`）

2. **保存未完成的内容**：
   - 遇到新标题时，先保存之前的问答对
   - 避免内容丢失

3. **长度限制**：
   - 子标题长度限制为 20 个字符
   - 避免将普通句子误判为标题

## 📊 预期效果

修复后，应该能够正确识别所有标题：

```
============================================================
处理完成统计:
  - 总行数: 6,791,470
  - 识别标题数: ~1,200,000  （之前只有 1 个）
  - 处理内容行数: ~5,000,000  （之前只有 5 行）
  - 保存问答对数: ~1,190,000  （之前只有 1 条）
  - keep_cnt: ~1,190,000
============================================================
```

## 🎯 验证方法

### 1. 重新运行脚本

```bash
cd pretrain
python download_and_process_datasets.py --process
```

### 2. 查看调试日志

重点关注：

**前 10 个标题识别信息**：
```
识别标题 #1: '数学' -> prompt: '什么是数学？'
识别标题 #2: '词源' -> prompt: '介绍一下词源'
识别标题 #3: '历史' -> prompt: '你知道历史吗？'
识别标题 #4: '形成、纯数学与应用数学及美学' -> prompt: '...'
识别标题 #5: '符号、语言与精确性' -> prompt: '...'
...
```

**进度信息**：
```
已处理 100000 行，识别标题 5000 个，内容行 80000 行，保存 4500 条
已处理 200000 行，识别标题 10000 个，内容行 160000 行，保存 9000 条
...
```

**最终统计**：
```
识别标题数: ~1,200,000  （不再是 1 个）
处理内容行数: ~5,000,000  （不再是 5 行）
保存问答对数: ~1,190,000  （不再是 1 条）
```

### 3. 检查生成的数据

```bash
# 查看生成的 parquet 文件大小
ls -lh data/my_data/wiki_zh_simple.parquet

# 使用 Python 查看数据量
python -c "import pandas as pd; df = pd.read_parquet('data/my_data/wiki_zh_simple.parquet'); print(f'数据量: {len(df)} 行')"
```

## 💡 经验教训

### 1. 理解数据格式很重要

在处理数据之前，必须先仔细查看数据的实际格式：
```bash
head -50 data/wiki.simple.txt
```

### 2. 不要假设数据格式

原代码假设：
- 标题行只以冒号结尾
- 标题行的上一行一定是空行

但实际上：
- 标题行有两种格式（冒号和句号）
- 标题行的上一行可能是内容行

### 3. 调试日志很有用

添加详细的调试日志帮助我们快速定位问题：
- 识别标题数：只有 1 个 → 标题识别有问题
- 处理内容行数：只有 5 行 → 大部分内容没有被处理
- 保存问答对数：只有 1 条 → 只保存了第一个标题的内容

### 4. 边界条件要考虑

- 文件开头的特殊情况（`pre_line_len == 0`）
- 子标题的识别（以句号结尾）
- 长度限制（避免误判）

## 📝 修改的文件

1. ✅ [`pretrain/raw_data_process.py`](raw_data_process.py) - 修复标题识别逻辑
2. ✅ [`pretrain/WIKI_FIX_FINAL.md`](WIKI_FIX_FINAL.md) - 本说明文档

## 🚀 下一步

现在请重新运行脚本，应该能够正确处理 wiki 数据了：

```bash
cd pretrain
python download_and_process_datasets.py --process
```

---

**最后更新**：2026-02-02 17:32
**问题状态**：✅ 已修复
