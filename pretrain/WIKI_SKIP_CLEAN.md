# Wiki æ•°æ®å¤„ç† - è·³è¿‡æ¸…æ´—æ¨¡å¼

## ğŸ“‹ æ¦‚è¿°

`process_wiki_simple_to_dataset()` å‡½æ•°ç°åœ¨æ”¯æŒ **è·³è¿‡æ•°æ®æ¸…æ´—** æ¨¡å¼ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ `wiki.simple.txt` çš„åŸå§‹å†…å®¹ï¼Œä¸åšä»»ä½•æ ‡ç‚¹ç¬¦å·è½¬æ¢å’Œå»é‡å¤„ç†ã€‚

## ğŸ¯ ä½¿ç”¨åœºæ™¯

å¦‚æœä½ å·²ç»ä½¿ç”¨ `tokenize/process_zhwiki.py` å¤„ç†è¿‡ wiki æ•°æ®ï¼Œç”Ÿæˆäº† `data/wiki.simple.txt`ï¼Œé‚£ä¹ˆå¯ä»¥ç›´æ¥ä½¿ç”¨è¿™ä¸ªæ–‡ä»¶ï¼Œ**ä¸éœ€è¦å†åšä»»ä½•æ¸…æ´—å¤„ç†**ã€‚

`process_zhwiki.py` å·²ç»å®Œæˆäº†ï¼š
- âœ… ç¹ä½“è½¬ç®€ä½“
- âœ… æ¸…ç†ç©ºè¡Œ
- âœ… æ–‡æœ¬æå–å’Œæ ¼å¼åŒ–

æ‰€ä»¥ä¸éœ€è¦å†è¿›è¡Œï¼š
- âŒ è‹±æ–‡æ ‡ç‚¹è½¬ä¸­æ–‡æ ‡ç‚¹
- âŒ åˆ é™¤é‡å¤æ ‡ç‚¹
- âŒ ç©ºæ ¼æ›¿æ¢ä¸ºé€—å·

## ğŸ”§ å‡½æ•°ç­¾å

```python
def process_wiki_simple_to_dataset(
    groups_cnt: int = 10000,
    max_len: int = 512,
    seed: int = 23333,
    skip_clean: bool = True  # æ–°å¢å‚æ•°ï¼Œé»˜è®¤ä¸º True
) -> None:
```

### å‚æ•°è¯´æ˜

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `groups_cnt` | int | 10000 | æ¯æ¬¡å†™å…¥ parquet æ–‡ä»¶çš„è¡Œæ•° |
| `max_len` | int | 512 | ç­”æ¡ˆçš„æœ€å¤§é•¿åº¦ |
| `seed` | int | 23333 | éšæœºç§å­ |
| `skip_clean` | bool | **True** | **æ˜¯å¦è·³è¿‡æ•°æ®æ¸…æ´—ï¼ˆé»˜è®¤ Trueï¼‰** |

## ğŸ“Š ä¸¤ç§æ¨¡å¼å¯¹æ¯”

### æ¨¡å¼ 1ï¼šè·³è¿‡æ¸…æ´—ï¼ˆæ¨èï¼Œé»˜è®¤ï¼‰

```python
# ä½¿ç”¨é»˜è®¤å‚æ•°ï¼ˆskip_clean=Trueï¼‰
process_wiki_simple_to_dataset()

# æˆ–è€…æ˜¾å¼æŒ‡å®š
process_wiki_simple_to_dataset(skip_clean=True)
```

**ç‰¹ç‚¹**ï¼š
- âœ… **ç›´æ¥ä½¿ç”¨åŸå§‹å†…å®¹**ï¼Œä¸åšä»»ä½•å¤„ç†
- âœ… **ä¿ç•™åŸå§‹æ ‡ç‚¹ç¬¦å·**ï¼ˆè‹±æ–‡å†’å· `:`ã€è‹±æ–‡é€—å·ç­‰ï¼‰
- âœ… **å¤„ç†é€Ÿåº¦æ›´å¿«**
- âœ… **é€‚åˆå·²ç»å¤„ç†è¿‡çš„ wiki.simple.txt**

**æ•°æ®æµç¨‹**ï¼š
```
wiki.simple.txt (åŸå§‹) 
    â†“
ç›´æ¥è¯»å–ï¼Œä¸åšä»»ä½•æ¸…æ´—
    â†“
ç”Ÿæˆé—®ç­”å¯¹
    â†“
ä¿å­˜ä¸º parquet
```

### æ¨¡å¼ 2ï¼šè¿›è¡Œæ¸…æ´—

```python
# æ˜¾å¼æŒ‡å®š skip_clean=False
process_wiki_simple_to_dataset(skip_clean=False)
```

**ç‰¹ç‚¹**ï¼š
- ğŸ”„ **è‹±æ–‡æ ‡ç‚¹è½¬ä¸­æ–‡æ ‡ç‚¹**ï¼ˆ`:` â†’ `ï¼š`ï¼Œ`,` â†’ `ï¼Œ`ç­‰ï¼‰
- ğŸ”„ **åˆ é™¤é‡å¤æ ‡ç‚¹ç¬¦å·**
- ğŸ”„ **ç©ºæ ¼æ›¿æ¢ä¸ºé€—å·**
- âš ï¸ **å¤„ç†é€Ÿåº¦è¾ƒæ…¢**
- âš ï¸ **å¯èƒ½æ”¹å˜åŸå§‹å†…å®¹çš„æ ¼å¼**

**æ•°æ®æµç¨‹**ï¼š
```
wiki.simple.txt (åŸå§‹)
    â†“
convert_en_punctuation_to_zh_punct()  # è‹±æ–‡æ ‡ç‚¹ â†’ ä¸­æ–‡æ ‡ç‚¹
    â†“
remove_duplicate_punctuation()  # åˆ é™¤é‡å¤æ ‡ç‚¹
    â†“
ç”Ÿæˆé—®ç­”å¯¹
    â†“
ä¿å­˜ä¸º parquet
```

## ğŸ” å…³é”®é€»è¾‘å˜åŒ–

### 1. `process_line()` å‡½æ•°

```python
def process_line(line: str, skip_clean: bool) -> str:
    '''å¤„ç†ä¸€è¡Œæ–‡æœ¬'''
    if skip_clean:
        return line  # ç›´æ¥è¿”å›åŸå§‹å†…å®¹ï¼Œä¸åšä»»ä½•å¤„ç†
    
    # å¦åˆ™è¿›è¡Œæ¸…æ´—
    line = convert_en_punctuation_to_zh_punct(line)
    line = remove_duplicate_punctuation(line)
    return line
```

### 2. å†’å·åˆ¤æ–­é€»è¾‘

```python
# æ ¹æ® skip_clean å‚æ•°é€‰æ‹©åˆ¤æ–­çš„å†’å·ç±»å‹
colon_to_check = ':' if skip_clean else 'ï¼š'

# åˆ¤æ–­æ˜¯å¦æ˜¯å†…å®¹è¡Œï¼ˆä¸æ˜¯æ ‡é¢˜è¡Œï¼‰
if prompt != '' and not line.endswith(colon_to_check):
    # å¤„ç†å†…å®¹...
```

**ä¸ºä»€ä¹ˆè¦è¿™æ ·åˆ¤æ–­ï¼Ÿ**

- å¦‚æœ `skip_clean=True`ï¼š
  - åŸå§‹å†…å®¹ä¿ç•™è‹±æ–‡å†’å· `:`
  - æ‰€ä»¥åˆ¤æ–­æ—¶ä½¿ç”¨è‹±æ–‡å†’å· `:`
  
- å¦‚æœ `skip_clean=False`ï¼š
  - `convert_en_punctuation_to_zh_punct()` ä¼šå°† `:` è½¬æ¢ä¸º `ï¼š`
  - æ‰€ä»¥åˆ¤æ–­æ—¶ä½¿ç”¨ä¸­æ–‡å†’å· `ï¼š`

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹ 1ï¼šä½¿ç”¨é»˜è®¤æ¨¡å¼ï¼ˆæ¨èï¼‰

```python
from raw_data_process import process_wiki_simple_to_dataset

# ç›´æ¥è°ƒç”¨ï¼Œä½¿ç”¨é»˜è®¤å‚æ•°ï¼ˆskip_clean=Trueï¼‰
process_wiki_simple_to_dataset()
```

### ç¤ºä¾‹ 2ï¼šè‡ªå®šä¹‰å‚æ•°

```python
# è‡ªå®šä¹‰å‚æ•°ï¼Œä½†ä»ç„¶è·³è¿‡æ¸…æ´—
process_wiki_simple_to_dataset(
    groups_cnt=20000,  # æ¯æ¬¡å†™å…¥ 20000 è¡Œ
    max_len=1024,      # ç­”æ¡ˆæœ€å¤§é•¿åº¦ 1024
    skip_clean=True    # è·³è¿‡æ¸…æ´—
)
```

### ç¤ºä¾‹ 3ï¼šä½¿ç”¨æ¸…æ´—æ¨¡å¼

```python
# å¦‚æœä½ æƒ³è¿›è¡Œæ•°æ®æ¸…æ´—ï¼ˆä¸æ¨èï¼Œé™¤éæœ‰ç‰¹æ®Šéœ€æ±‚ï¼‰
process_wiki_simple_to_dataset(skip_clean=False)
```

## ğŸ‰ ä¼˜åŠ¿

ä½¿ç”¨ `skip_clean=True`ï¼ˆé»˜è®¤æ¨¡å¼ï¼‰çš„ä¼˜åŠ¿ï¼š

1. **âœ… ä¿ç•™åŸå§‹æ ¼å¼**ï¼šä¸æ”¹å˜ `process_zhwiki.py` å¤„ç†åçš„å†…å®¹
2. **âœ… å¤„ç†é€Ÿåº¦æ›´å¿«**ï¼šè·³è¿‡æ ‡ç‚¹ç¬¦å·è½¬æ¢å’Œå»é‡æ­¥éª¤
3. **âœ… é¿å…æ ¼å¼ç ´å**ï¼šä¸ä¼šå› ä¸ºæ ‡ç‚¹ç¬¦å·è½¬æ¢å¯¼è‡´æ ¼å¼è¯†åˆ«é”™è¯¯
4. **âœ… æ›´ç®€æ´**ï¼šç›´æ¥ä½¿ç”¨åŸå§‹å†…å®¹ï¼Œé€»è¾‘æ›´æ¸…æ™°

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **ç¡®ä¿ `wiki.simple.txt` å·²å­˜åœ¨**ï¼š
   ```bash
   # å¦‚æœæ²¡æœ‰ï¼Œå…ˆè¿è¡Œ
   cd tokenize
   python process_zhwiki.py
   ```

2. **æ–‡ä»¶æ ¼å¼è¦æ±‚**ï¼š
   - è¯æ¡åä»¥**è‹±æ–‡å†’å· `:`** ç»“å°¾
   - è¯æ¡ååæ˜¯ç©ºè¡Œ
   - ç„¶åæ˜¯å†…å®¹æ®µè½

3. **é»˜è®¤è¡Œä¸ºå·²æ”¹å˜**ï¼š
   - ä¹‹å‰é»˜è®¤ä¼šè¿›è¡Œæ¸…æ´—
   - ç°åœ¨é»˜è®¤ **è·³è¿‡æ¸…æ´—**ï¼ˆ`skip_clean=True`ï¼‰
   - å¦‚æœéœ€è¦æ¸…æ´—ï¼Œè¯·æ˜¾å¼æŒ‡å®š `skip_clean=False`

## ğŸ”„ è¿ç§»æŒ‡å—

å¦‚æœä½ ä¹‹å‰ä½¿ç”¨çš„æ˜¯æ—§ç‰ˆæœ¬çš„ `process_wiki_simple_to_dataset()`ï¼š

### æ—§ç‰ˆæœ¬ï¼ˆè‡ªåŠ¨æ¸…æ´—ï¼‰
```python
# æ—§ç‰ˆæœ¬ä¼šè‡ªåŠ¨è¿›è¡Œæ¸…æ´—
process_wiki_simple_to_dataset()
```

### æ–°ç‰ˆæœ¬ï¼ˆé»˜è®¤è·³è¿‡æ¸…æ´—ï¼‰
```python
# æ–°ç‰ˆæœ¬é»˜è®¤è·³è¿‡æ¸…æ´—
process_wiki_simple_to_dataset()  # skip_clean=Trueï¼ˆé»˜è®¤ï¼‰

# å¦‚æœæƒ³ä¿æŒæ—§ç‰ˆæœ¬çš„è¡Œä¸ºï¼ˆè¿›è¡Œæ¸…æ´—ï¼‰
process_wiki_simple_to_dataset(skip_clean=False)
```

## ğŸ“š ç›¸å…³æ–‡ä»¶

- [`tokenize/process_zhwiki.py`](../tokenize/process_zhwiki.py) - Wiki æ•°æ®ä¸‹è½½å’Œé¢„å¤„ç†è„šæœ¬
- [`pretrain/raw_data_process.py`](raw_data_process.py) - æ•°æ®å¤„ç†ä¸»è„šæœ¬
- [`data/wiki.simple.txt`](../data/wiki.simple.txt) - å¤„ç†åçš„ Wiki æ•°æ®ï¼ˆéœ€è¦å…ˆç”Ÿæˆï¼‰

## ğŸ¯ æ€»ç»“

- **é»˜è®¤è¡Œä¸º**ï¼š`skip_clean=True`ï¼Œç›´æ¥ä½¿ç”¨åŸå§‹å†…å®¹
- **æ¨èä½¿ç”¨**ï¼šå¦‚æœå·²ç»ç”¨ `process_zhwiki.py` å¤„ç†è¿‡ï¼Œä½¿ç”¨é»˜è®¤æ¨¡å¼
- **ç‰¹æ®Šéœ€æ±‚**ï¼šå¦‚æœéœ€è¦è¿›ä¸€æ­¥æ¸…æ´—ï¼Œè®¾ç½® `skip_clean=False`

---

**æœ€åæ›´æ–°**ï¼š2026-02-02
