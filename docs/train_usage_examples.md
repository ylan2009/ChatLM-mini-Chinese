# train.py ä½¿ç”¨ç¤ºä¾‹å’Œå‚æ•°è¯´æ˜

## ğŸ“‹ åŸºæœ¬ç”¨æ³•

### 1. é¢„è®­ç»ƒï¼ˆä½¿ç”¨é»˜è®¤é…ç½®ï¼‰

```bash
accelerate launch --multi_gpu --num_processes 2 ./train.py train
```

**é»˜è®¤é…ç½®**ï¼š
- è®­ç»ƒè½®æ•°ï¼š8 epochs
- å­¦ä¹ ç‡ï¼š0.0001
- ä¸å†»ç»“å‚æ•°ï¼ˆè®­ç»ƒæ‰€æœ‰å±‚ï¼‰

---

### 2. SFT å¾®è°ƒï¼ˆä½¿ç”¨é»˜è®¤é…ç½®ï¼‰

```bash
accelerate launch --multi_gpu --num_processes 2 ./train.py train --is_finetune=True
```

**é»˜è®¤é…ç½®**ï¼š
- è®­ç»ƒè½®æ•°ï¼š8 epochsï¼ˆå»ºè®®æ”¹ä¸º 3-5ï¼‰
- å­¦ä¹ ç‡ï¼š0.0001ï¼ˆå»ºè®®æ”¹ä¸º 1e-5ï¼‰
- å†»ç»“ encoder å’Œ embeddingï¼ˆåªè®­ç»ƒ decoderï¼‰

---

## ğŸ¯ è‡ªå®šä¹‰å‚æ•°

### 3. é¢„è®­ç»ƒï¼ˆè‡ªå®šä¹‰å­¦ä¹ ç‡å’Œè®­ç»ƒè½®æ•°ï¼‰

```bash
accelerate launch --multi_gpu --num_processes 2 ./train.py train \
    --epochs=10 \
    --learn_rate=0.0002
```

**è¯´æ˜**ï¼š
- `--epochs=10`ï¼šè®­ç»ƒ 10 è½®
- `--learn_rate=0.0002`ï¼šä½¿ç”¨ 0.0002 çš„å­¦ä¹ ç‡

---

### 4. SFT å¾®è°ƒï¼ˆæ¨èé…ç½®ï¼‰

```bash
accelerate launch --multi_gpu --num_processes 2 ./train.py train \
    --is_finetune=True \
    --epochs=5 \
    --learn_rate=1e-5
```

**è¯´æ˜**ï¼š
- `--is_finetune=True`ï¼šå¯ç”¨å¾®è°ƒæ¨¡å¼ï¼ˆå†»ç»“ encoder å’Œ embeddingï¼‰
- `--epochs=5`ï¼šè®­ç»ƒ 5 è½®ï¼ˆå¾®è°ƒé€šå¸¸ä¸éœ€è¦å¤ªå¤šè½®æ•°ï¼‰
- `--learn_rate=1e-5`ï¼šä½¿ç”¨è¾ƒå°çš„å­¦ä¹ ç‡ï¼ˆé¿å…ç ´åé¢„è®­ç»ƒæƒé‡ï¼‰

**ä¸ºä»€ä¹ˆä½¿ç”¨æ›´å°çš„å­¦ä¹ ç‡ï¼Ÿ**
- é¢„è®­ç»ƒæ¨¡å‹å·²ç»æ”¶æ•›åˆ°è¾ƒå¥½çš„ä½ç½®
- å¾®è°ƒåªéœ€è¦å°å¹…è°ƒæ•´ï¼Œå¤§å­¦ä¹ ç‡ä¼šç ´åé¢„è®­ç»ƒæƒé‡
- é€šå¸¸å¾®è°ƒå­¦ä¹ ç‡æ˜¯é¢„è®­ç»ƒçš„ 1/10 åˆ° 1/100

---

### 5. ä»æ–­ç‚¹ç»§ç»­è®­ç»ƒ

```bash
accelerate launch --multi_gpu --num_processes 2 ./train.py train \
    --is_keep_training=True \
    --epochs=8 \
    --learn_rate=0.0001
```

**è¯´æ˜**ï¼š
- `--is_keep_training=True`ï¼šä» `train_state_dir` åŠ è½½ä¹‹å‰çš„è®­ç»ƒçŠ¶æ€
- ä¼šæ¢å¤ä¼˜åŒ–å™¨çŠ¶æ€ã€å­¦ä¹ ç‡è°ƒåº¦å™¨çŠ¶æ€ç­‰
- å¯ä»¥ç»§ç»­ä¹‹å‰çš„è®­ç»ƒï¼Œæ— éœ€ä»å¤´å¼€å§‹

---

## ğŸ“Š å‚æ•°å¯¹æ¯”è¡¨

| åœºæ™¯ | å‘½ä»¤ç¤ºä¾‹ | epochs | learn_rate | is_finetune |
|------|----------|--------|------------|-------------|
| **é¢„è®­ç»ƒï¼ˆé»˜è®¤ï¼‰** | `train` | 8 | 0.0001 | False |
| **é¢„è®­ç»ƒï¼ˆè‡ªå®šä¹‰ï¼‰** | `train --epochs=10 --learn_rate=0.0002` | 10 | 0.0002 | False |
| **SFTå¾®è°ƒï¼ˆé»˜è®¤ï¼‰** | `train --is_finetune=True` | 8 | 0.0001 | True |
| **SFTå¾®è°ƒï¼ˆæ¨èï¼‰** | `train --is_finetune=True --epochs=5 --learn_rate=1e-5` | 5 | 1e-5 | True |
| **æ–­ç‚¹ç»­è®­** | `train --is_keep_training=True` | 8 | 0.0001 | False |

---

## ğŸ”§ å‚æ•°è¯¦ç»†è¯´æ˜

### `train` å‡½æ•°å‚æ•°

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `is_keep_training` | bool | False | æ˜¯å¦ä»æ–­ç‚¹å¤„åŠ è½½çŠ¶æ€ç»§ç»­è®­ç»ƒ |
| `is_finetune` | bool | False | æ˜¯å¦å¾®è°ƒï¼Œå¾®è°ƒä¼šå†»ç»“ encoder å’Œ embedding |
| `epochs` | int | None | è®­ç»ƒè½®æ•°ï¼Œå¦‚æœæŒ‡å®šåˆ™è¦†ç›– `TrainConfig.epochs` |
| `learn_rate` | float | None | å­¦ä¹ ç‡ï¼Œå¦‚æœæŒ‡å®šåˆ™è¦†ç›– `TrainConfig.learn_rate` |

### å‚æ•°ä¼˜å…ˆçº§

1. **å‘½ä»¤è¡Œå‚æ•°**ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
   - å¦‚æœæŒ‡å®šäº† `--epochs` æˆ– `--learn_rate`ï¼Œä¼šè¦†ç›–é…ç½®æ–‡ä»¶ä¸­çš„å€¼

2. **TrainConfig é»˜è®¤å€¼**
   - å¦‚æœæ²¡æœ‰æŒ‡å®šå‘½ä»¤è¡Œå‚æ•°ï¼Œä½¿ç”¨ `config.py` ä¸­çš„é»˜è®¤å€¼

---

## ğŸ’¡ ä½¿ç”¨å»ºè®®

### é¢„è®­ç»ƒé˜¶æ®µ

```bash
# æ¨èé…ç½®
accelerate launch --multi_gpu --num_processes 2 ./train.py train \
    --epochs=8 \
    --learn_rate=0.0001
```

**ç‰¹ç‚¹**ï¼š
- è¾ƒå¤§å­¦ä¹ ç‡ï¼ˆ0.0001ï¼‰
- è¾ƒå¤šè®­ç»ƒè½®æ•°ï¼ˆ8+ï¼‰
- è®­ç»ƒæ‰€æœ‰å‚æ•°

### SFT å¾®è°ƒé˜¶æ®µ

```bash
# æ¨èé…ç½®
accelerate launch --multi_gpu --num_processes 2 ./train.py train \
    --is_finetune=True \
    --epochs=5 \
    --learn_rate=1e-5
```

**ç‰¹ç‚¹**ï¼š
- **è¾ƒå°å­¦ä¹ ç‡**ï¼ˆ1e-5ï¼Œé‡è¦ï¼ï¼‰
- è¾ƒå°‘è®­ç»ƒè½®æ•°ï¼ˆ3-5ï¼‰
- å†»ç»“ encoder å’Œ embeddingï¼Œåªè®­ç»ƒ decoder

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å­¦ä¹ ç‡é€‰æ‹©**ï¼š
   - é¢„è®­ç»ƒï¼šå¯ä»¥ä½¿ç”¨è¾ƒå¤§çš„å­¦ä¹ ç‡ï¼ˆ1e-4ï¼‰
   - å¾®è°ƒï¼š**å¿…é¡»ä½¿ç”¨è¾ƒå°çš„å­¦ä¹ ç‡**ï¼ˆ1e-5 æˆ–æ›´å°ï¼‰ï¼Œå¦åˆ™ä¼šç ´åé¢„è®­ç»ƒæƒé‡

2. **è®­ç»ƒè½®æ•°**ï¼š
   - é¢„è®­ç»ƒï¼šé€šå¸¸éœ€è¦è¾ƒå¤šè½®æ•°ï¼ˆ8+ï¼‰
   - å¾®è°ƒï¼šé€šå¸¸åªéœ€è¦è¾ƒå°‘è½®æ•°ï¼ˆ3-5ï¼‰ï¼Œé¿å…è¿‡æ‹Ÿåˆ

3. **å‚æ•°è¦†ç›–**ï¼š
   - å‘½ä»¤è¡Œå‚æ•°ä¼šè¦†ç›–é…ç½®æ–‡ä»¶ä¸­çš„å€¼
   - å¦‚æœåŒæ—¶æŒ‡å®šäº† `--epochs` å’Œ `--learn_rate`ï¼Œä¸¤è€…éƒ½ä¼šç”Ÿæ•ˆ

4. **å¾®è°ƒæ¨¡å¼**ï¼š
   - `--is_finetune=True` ä¼šè‡ªåŠ¨ï¼š
     - åŠ è½½é¢„è®­ç»ƒæ¨¡å‹ï¼ˆä» `finetune_from_ckp_file`ï¼‰
     - å†»ç»“ `model.shared` (embedding)
     - å†»ç»“ `model.encoder`
     - åªè®­ç»ƒ `model.decoder`

---

## ğŸ”— ç›¸å…³æ–‡ä»¶

- `train.py` - è®­ç»ƒè„šæœ¬å…¥å£
- `model/trainer.py` - `ChatTrainer.train()` æ–¹æ³•å®ç°
- `config.py` - `TrainConfig` é…ç½®ç±»
