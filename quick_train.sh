#!/bin/bash
# х┐лщАЯшонч╗ГшДЪцЬмя╝ЪщЗЗца╖1ф╕ЗцЭбцХ░цНох╣╢хРпхКишонч╗Г

set -e  # щБЗхИ░щФЩшппчлЛхН│щААхЗ║

echo "=========================================="
echo "  SFTх┐лщАЯшонч╗ГшДЪцЬмя╝И1ф╕ЗцЭбцХ░цНоя╝Й"
echo "=========================================="

# ш┐ЫхЕещб╣чЫочЫох╜Х
cd "$(dirname "$0")"
PROJECT_DIR=$(pwd)

echo ""
echo "ЁЯУВ щб╣чЫочЫох╜Х: $PROJECT_DIR"
echo ""

# цнещкд1я╝ЪщЗЗца╖цХ░цНо
echo "=========================================="
echo "цнещкд 1/3: щЗЗца╖цХ░цНощЫЖ"
echo "=========================================="
echo "ф╗О10ф╕ЗцЭбцХ░цНоф╕нщЗЗца╖1ф╕ЗцЭбшонч╗ГцХ░цНохТМ1хНГцЭбщкМшпБцХ░цНо..."
echo ""

python3 sample_data.py

if [ $? -ne 0 ]; then
    echo "тЭМ цХ░цНощЗЗца╖хд▒ш┤ея╝Б"
    exit 1
fi

echo ""
echo "тЬЕ цХ░цНощЗЗца╖хоМцИРя╝Б"
echo ""

# цнещкд2я╝Ъц╕ЕчРЖцЧзчЪДшонч╗ГчК╢цАБ
echo "=========================================="
echo "цнещкд 2/3: ц╕ЕчРЖцЧзчЪДшонч╗ГчК╢цАБ"
echo "=========================================="

TRAIN_STATE_DIR="$PROJECT_DIR/model_save/sft/train_latest_state_sft"

if [ -d "$TRAIN_STATE_DIR" ]; then
    echo "хПСчО░цЧзчЪДшонч╗ГчК╢цАБчЫох╜Хя╝МцнгхЬиц╕ЕчРЖ..."
    rm -rf "$TRAIN_STATE_DIR"
    echo "тЬЕ х╖▓ц╕ЕчРЖцЧзчЪДшонч╗ГчК╢цАБ"
else
    echo "тЬЕ цЧащЬАц╕ЕчРЖя╝ИцЬкхПСчО░цЧзчЪДшонч╗ГчК╢цАБя╝Й"
fi

echo ""

# цнещкд3я╝ЪхРпхКишонч╗Г
echo "=========================================="
echo "цнещкд 3/3: хРпхКишонч╗Г"
echo "=========================================="
echo ""
echo "шонч╗ГщЕНч╜оя╝Ъ"
echo "  - шонч╗ГцХ░цНо: 10,000 цЭб"
echo "  - щкМшпБцХ░цНо: 1,000 цЭб"
echo "  - шонч╗Гш╜оцХ░: 10 epochs"
echo "  - Batch size: 20 (per GPU)"
echo "  - хнжф╣ачОЗ: 2e-5"
echo "  - GPUцХ░щЗП: 2"
echo ""
echo "щвДшобшонч╗ГцЧ╢щЧ┤: ч║ж 30-60 хИЖщТЯ"
echo ""
echo "х╝АхзЛшонч╗Г..."
echo ""

# хРпхКишонч╗Г
accelerate launch --multi_gpu --num_processes 2 ./train.py train --is_finetune=True

echo ""
echo "=========================================="
echo "тЬЕ шонч╗ГхоМцИРя╝Б"
echo "=========================================="
echo ""
echo "цЯечЬЛшонч╗ГцЧех┐Чя╝Ъ"
echo "  tail -f logs/chat_trainer_*.log"
echo ""
echo "цЯечЬЛцибхЮЛцЦЗф╗╢я╝Ъ"
echo "  ls -lh model_save/sft/"
echo ""
